<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Tracking Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #666;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>üß™ Lesson Tracking Test Suite</h1>
    
    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearStorage()">Clear localStorage</button>
        <button onclick="showStorage()">Show Current Storage</button>
    </div>

    <div id="test-results"></div>

    <div class="test-section">
        <h2>Current localStorage Contents</h2>
        <pre id="storage-display">Click "Show Current Storage" to view</pre>
    </div>

    <script type="module">
        // Import the lesson tracking functions
        // Note: In a real browser environment, these would be imported from the actual module
        // For testing purposes, we'll recreate the functions here
        
        const STORAGE_KEY = 'completedLessons';

        function getCompletedLessons() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Error reading completed lessons:', error);
                return [];
            }
        }

        function isLessonCompleted(language, lessonId) {
            const completed = getCompletedLessons();
            return completed.some(
                (lesson) => lesson.language === language && lesson.lessonId === String(lessonId)
            );
        }

        function markLessonComplete(language, lessonId) {
            if (isLessonCompleted(language, lessonId)) {
                return false;
            }

            try {
                const completed = getCompletedLessons();
                const newCompletion = {
                    language: language,
                    lessonId: String(lessonId),
                    completedAt: Date.now()
                };

                completed.push(newCompletion);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
                return true;
            } catch (error) {
                console.error('Error saving completed lesson:', error);
                return false;
            }
        }

        function getCompletedLessonsCount() {
            return getCompletedLessons().length;
        }

        // Test functions
        function runAllTests() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h2>Test Results</h2>';
            
            let passCount = 0;
            let failCount = 0;

            // Test 1: Initial state should be empty
            clearStorage();
            const initialCount = getCompletedLessonsCount();
            if (initialCount === 0) {
                addTestResult('Test 1: Initial state is empty', true);
                passCount++;
            } else {
                addTestResult('Test 1: Initial state is empty', false, `Expected 0, got ${initialCount}`);
                failCount++;
            }

            // Test 2: Mark lesson as complete
            const markResult = markLessonComplete('spanish', '1');
            if (markResult === true) {
                addTestResult('Test 2: Mark lesson as complete', true);
                passCount++;
            } else {
                addTestResult('Test 2: Mark lesson as complete', false, 'markLessonComplete returned false');
                failCount++;
            }

            // Test 3: Verify lesson is completed
            const isCompleted = isLessonCompleted('spanish', '1');
            if (isCompleted === true) {
                addTestResult('Test 3: Lesson is marked as completed', true);
                passCount++;
            } else {
                addTestResult('Test 3: Lesson is marked as completed', false, 'isLessonCompleted returned false');
                failCount++;
            }

            // Test 4: Count should be 1
            const count1 = getCompletedLessonsCount();
            if (count1 === 1) {
                addTestResult('Test 4: Count is correct after one completion', true);
                passCount++;
            } else {
                addTestResult('Test 4: Count is correct after one completion', false, `Expected 1, got ${count1}`);
                failCount++;
            }

            // Test 5: Prevent duplicate
            const duplicateResult = markLessonComplete('spanish', '1');
            if (duplicateResult === false) {
                addTestResult('Test 5: Duplicate prevention works', true);
                passCount++;
            } else {
                addTestResult('Test 5: Duplicate prevention works', false, 'Duplicate was allowed');
                failCount++;
            }

            // Test 6: Count should still be 1
            const count2 = getCompletedLessonsCount();
            if (count2 === 1) {
                addTestResult('Test 6: Count remains 1 after duplicate attempt', true);
                passCount++;
            } else {
                addTestResult('Test 6: Count remains 1 after duplicate attempt', false, `Expected 1, got ${count2}`);
                failCount++;
            }

            // Test 7: Add multiple lessons
            markLessonComplete('french', '2');
            markLessonComplete('german', '3');
            const count3 = getCompletedLessonsCount();
            if (count3 === 3) {
                addTestResult('Test 7: Multiple lessons tracked correctly', true);
                passCount++;
            } else {
                addTestResult('Test 7: Multiple lessons tracked correctly', false, `Expected 3, got ${count3}`);
                failCount++;
            }

            // Test 8: Verify all lessons are tracked
            const allCompleted = getCompletedLessons();
            const hasSpanish = allCompleted.some(l => l.language === 'spanish' && l.lessonId === '1');
            const hasFrench = allCompleted.some(l => l.language === 'french' && l.lessonId === '2');
            const hasGerman = allCompleted.some(l => l.language === 'german' && l.lessonId === '3');
            
            if (hasSpanish && hasFrench && hasGerman) {
                addTestResult('Test 8: All lessons stored correctly', true);
                passCount++;
            } else {
                addTestResult('Test 8: All lessons stored correctly', false, 
                    `Missing: spanish=${hasSpanish}, french=${hasFrench}, german=${hasGerman}`);
                failCount++;
            }

            // Test 9: Verify timestamp exists
            const spanishLesson = allCompleted.find(l => l.language === 'spanish' && l.lessonId === '1');
            if (spanishLesson && spanishLesson.completedAt && typeof spanishLesson.completedAt === 'number') {
                addTestResult('Test 9: Timestamp is stored correctly', true);
                passCount++;
            } else {
                addTestResult('Test 9: Timestamp is stored correctly', false, 'Timestamp missing or invalid');
                failCount++;
            }

            // Test 10: Verify lessonId is string
            if (spanishLesson && typeof spanishLesson.lessonId === 'string') {
                addTestResult('Test 10: lessonId is stored as string', true);
                passCount++;
            } else {
                addTestResult('Test 10: lessonId is stored as string', false, 'lessonId is not a string');
                failCount++;
            }

            // Summary
            const summary = document.createElement('div');
            summary.className = 'test-section';
            summary.innerHTML = `
                <h2>Test Summary</h2>
                <p><strong>Total Tests:</strong> ${passCount + failCount}</p>
                <p style="color: green;"><strong>Passed:</strong> ${passCount}</p>
                <p style="color: ${failCount > 0 ? 'red' : 'green'}"><strong>Failed:</strong> ${failCount}</p>
                <p><strong>Success Rate:</strong> ${Math.round((passCount / (passCount + failCount)) * 100)}%</p>
            `;
            results.appendChild(summary);
        }

        function addTestResult(testName, passed, message = '') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${passed ? 'pass' : 'fail'}`;
            div.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong>
                ${message ? `<br><small>${message}</small>` : ''}
            `;
            results.appendChild(div);
        }

        function clearStorage() {
            localStorage.removeItem('completedLessons');
            showStorage();
        }

        function showStorage() {
            const display = document.getElementById('storage-display');
            const stored = localStorage.getItem('completedLessons');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    display.textContent = JSON.stringify(parsed, null, 2);
                } catch (e) {
                    display.textContent = `Error parsing: ${e.message}\n\nRaw: ${stored}`;
                }
            } else {
                display.textContent = 'No data in localStorage';
            }
        }

        // Make functions available globally
        window.runAllTests = runAllTests;
        window.clearStorage = clearStorage;
        window.showStorage = showStorage;

        // Auto-run tests on load
        window.addEventListener('load', () => {
            console.log('Lesson Tracking Test Suite Loaded');
            console.log('Click "Run All Tests" to begin testing');
        });
    </script>
</body>
</html>

